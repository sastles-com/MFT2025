# ğŸŒ MFT2025 Isolation Sphere

ESP32-S3ï¼ˆM5Atom S3Rï¼‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸçƒä½“ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã€‚  
ã‚»ãƒ³ã‚µãƒ¼ã§çƒä½“ã®å§¿å‹¢ã‚’æ¤œå‡ºã—ã€ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®æç”»åº§æ¨™ã‚’è£œæ­£ã™ã‚‹ã“ã¨ã§ã€**ãƒœãƒ¼ãƒ«ã‚’è»¢ãŒã—ã¦ã‚‚ç”»åƒã®å¤©åœ°ãŒä¿ãŸã‚Œã‚‹çƒä½“ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤**ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## âœ¨ ä¸»ãªæ©Ÿèƒ½

- ğŸ¥ **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å‹•ç”»å†ç”Ÿ** - èµ·å‹•æ™‚ã«LittleFSã‹ã‚‰JPEGé€£ç•ªå‹•ç”»ã‚’è‡ªå‹•å†ç”Ÿ
- ğŸµ **èµ·å‹•éŸ³å†ç”Ÿ** - M5Unifiedã®ãƒ–ã‚¶ãƒ¼æ©Ÿèƒ½ã«ã‚ˆã‚‹èµ·å‹•ã‚µã‚¦ãƒ³ãƒ‰
- ğŸ’¡ **800çƒLEDãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤** - 4æœ¬ã®WS2812ã‚¹ãƒˆãƒªãƒƒãƒ—ã«ã‚ˆã‚‹çƒä½“è¡¨ç¤º
- ğŸ¯ **å§¿å‹¢åˆ¶å¾¡** - IMUã‚»ãƒ³ã‚µãƒ¼ã«ã‚ˆã‚‹å§¿å‹¢æ¤œå‡ºã¨ãƒ†ã‚¯ã‚¹ãƒãƒ£è£œæ­£
- ğŸŒ **MQTT/UDPé€šä¿¡** - Raspberry Piã¨ã®é€£æºã«ã‚ˆã‚‹å¤–éƒ¨åˆ¶å¾¡
- ğŸ“± **Web UI** - ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®è¨­å®šãƒ»åˆ¶å¾¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- ğŸ”„ **OTAæ›´æ–°** - ç„¡ç·šã§ã®ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢æ›´æ–°

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```mermaid
flowchart TD
    subgraph ESP32[ESP32-S3 M5Atom S3R]
        subgraph Core0[Core 0]
            A1[LittleFS/PSRamFS] --> A2[ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å‹•ç”»]
            A2 --> A3[MQTT/UDPé€šä¿¡]
            A3 --> A4[LEDåˆ¶å¾¡]
        end
        
        subgraph Core1[Core 1]
            B1[ãƒ–ã‚¶ãƒ¼åˆ¶å¾¡]
            B2[LCDè¡¨ç¤º]
            B3[IMUå§¿å‹¢æ¤œå‡º]
        end
    end
    
    subgraph RPI[Raspberry Pi]
        C1[MQTT Broker]
        C2[Web UI]
    end
    
    ESP32 <--MQTT/UDP--> RPI
    
    subgraph Clients[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ]
        D1[PC/ã‚¹ãƒãƒ›]
    end
    
    RPI <--> Clients
```

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢

- **ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰**: M5Stack Atom S3R (ESP32-S3)
- **ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤**: å†…è”µLCD + 800çƒWS2812 LEDã‚¹ãƒˆãƒªãƒƒãƒ—Ã—4
- **ã‚»ãƒ³ã‚µãƒ¼**: BNO055 IMUã‚»ãƒ³ã‚µãƒ¼
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: LittleFS (3MB) + PSRam (3MB)

### ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢

- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: PlatformIO + Arduino
- **ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
  - `M5Unified` - M5Stackçµ±åˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª
  - `FastLED` - LEDåˆ¶å¾¡ï¼ˆI2S DMAå¯¾å¿œï¼‰
  - `LovyanGFX` / `M5GFX` - ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯æç”»
  - `AsyncMqttClient` - MQTTé€šä¿¡
  - `TJpg_Decoder` - JPEGç”»åƒãƒ‡ã‚³ãƒ¼ãƒ‰
  - `ESP32-PSRamFS` - PSRamãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ 

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. é–‹ç™ºç’°å¢ƒæº–å‚™

```bash
# PlatformIO CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install platformio

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/sastles-com/MFT2025.git
cd MFT2025
```

### 2. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pio lib install
```

### 3. ãƒ“ãƒ«ãƒ‰ã¨æ›¸ãè¾¼ã¿

```bash
# ãƒ“ãƒ«ãƒ‰
pio run -e atoms3r

# ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢æ›¸ãè¾¼ã¿
pio run -t upload -e atoms3r

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚¢ã‚»ãƒƒãƒˆï¼‰æ›¸ãè¾¼ã¿
pio run -t uploadfs -e atoms3r

# ã‚·ãƒªã‚¢ãƒ«ãƒ¢ãƒ‹ã‚¿ãƒ¼
pio device monitor -b 115200
```

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```text
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main.cpp              # ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
â”œâ”€â”€ include/                  # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ lib/                      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”œâ”€â”€ test/                     # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ spiffs_dir/              # LittleFSã‚¢ã‚»ãƒƒãƒˆ
â”‚   â”œâ”€â”€ config.json          # ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
â”‚   â”œâ”€â”€ led_layout.csv       # LEDåº§æ¨™å®šç¾©
â”‚   â””â”€â”€ images/              # ç”»åƒã‚¢ã‚»ãƒƒãƒˆ
â”‚       â”œâ”€â”€ opening/         # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å‹•ç”»
â”‚       â”œâ”€â”€ demo01/          # ãƒ‡ãƒ¢å‹•ç”»1
â”‚       â”œâ”€â”€ demo02/          # ãƒ‡ãƒ¢å‹•ç”»2
â”‚       â””â”€â”€ demo03/          # ãƒ‡ãƒ¢å‹•ç”»3
â”œâ”€â”€ platformio.ini           # PlatformIOè¨­å®š
â”œâ”€â”€ partitions.csv           # ESP32ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å®šç¾©
â”œâ”€â”€ isolation_sphere_spec.md # æŠ€è¡“ä»•æ§˜æ›¸
â”œâ”€â”€ isolation_sphere_tasks.md # å®Ÿè£…ã‚¿ã‚¹ã‚¯ä¸€è¦§
â”œâ”€â”€ mqtt_rules.md            # MQTTé€šä¿¡ä»•æ§˜
â””â”€â”€ AGENTS.md               # é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
```

## âš™ï¸ è¨­å®š

### config.json

```json
{
  "wifi": {
    "ssid": "your_wifi_ssid",
    "password": "your_wifi_password"
  },
  "mqtt": {
    "broker": "192.168.1.100",
    "port": 1883,
    "client_id": "isolation_sphere_01"
  },
  "display": {
    "brightness": 128,
    "rotation": 0
  },
  "led": {
    "strips": [180, 220, 180, 220],
    "pins": [5, 6, 7, 8],
    "max_fps": 30
  }
}
```

> **è£œè¶³**: LittleFS ã«æ›¸ãè¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹: `config.json`, ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯è¨­å®šãªã©ï¼‰ã¯ `data/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¾ã¨ã‚ã¦é…ç½®ã—ã¾ã™ã€‚åæ˜ ã™ã‚‹éš›ã¯ `pio run -t buildfs -e atoms3r_bmi270` â†’ `pio run -t uploadfs -e atoms3r_bmi270` ã‚’å®Ÿè¡Œã—ã¦ã€`data/` ã®å†…å®¹ã‚’ ESP32 ã¨åŒæœŸã•ã›ã¦ãã ã•ã„ã€‚

### LEDé…ç½® (led_layout.csv)

```csv
strip_id,index,x,y,z
0,0,-0.866,0.500,0.000
0,1,-0.866,0.485,0.129
...
```

## ğŸ® MQTTåˆ¶å¾¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### åŸºæœ¬ãƒˆãƒ”ãƒƒã‚¯æ§‹é€ 

```text
sphere/
â”œâ”€â”€ control/          # åˆ¶å¾¡ã‚³ãƒãƒ³ãƒ‰
â”œâ”€â”€ status/           # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±
â”œâ”€â”€ media/            # ãƒ¡ãƒ‡ã‚£ã‚¢åˆ¶å¾¡
â””â”€â”€ config/           # è¨­å®šå¤‰æ›´
```

### åˆ¶å¾¡ä¾‹

```bash
# å‹•ç”»å†ç”Ÿ
mosquitto_pub -t "sphere/media/play" -m '{"video": "demo01"}'

# LEDè¼åº¦èª¿æ•´
mosquitto_pub -t "sphere/control/brightness" -m '{"value": 200}'

# å§¿å‹¢ãƒªã‚»ãƒƒãƒˆ
mosquitto_pub -t "sphere/control/reset_orientation" -m '{}'
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pio test -e atoms3r

# ç‰¹å®šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pio test -e atoms3r -f test_config
```

## ğŸ”„ OTAã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

### ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ï¼ˆ`/update`ï¼‰

1. `config.json` ã® `ota.enabled` ã‚’ `true` ã«ã—ã€SSID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãƒ‡ãƒã‚¤ã‚¹ã‚’å†èµ·å‹•ã€‚
2. ã‚·ãƒªã‚¢ãƒ«ãƒ¢ãƒ‹ã‚¿ã« `OTA Service started. http://<IP>/ (user:admin)` ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€PC/ã‚¹ãƒãƒ›ã‚’åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã€‚
3. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://<IP>/update` ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã€Basicèªè¨¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `admin` / `sphere`ï¼‰ã‚’é€šéã€‚
4. `pio run -e atoms3r_bmi270` ç­‰ã§ç”Ÿæˆã•ã‚Œã‚‹ `firmware.bin` ã‚’æŒ‡å®šã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€‚å®Œäº†å¾Œã«è‡ªå‹•ã§å†èµ·å‹•ã—ã¾ã™ã€‚

### LittleFSã‚¢ã‚»ãƒƒãƒˆï¼ˆ`/uploadfs`ï¼‰

1. PCå´ã§ LittleFS ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç”Ÿæˆ:
   ```bash
   pio run -t buildfs -e atoms3r_bmi270
   ```
   ç”Ÿæˆç‰©ã¯ `.pio/build/atoms3r_bmi270/littlefs.bin` ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://<IP>/uploadfs` ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆåŒã˜Basicèªè¨¼ãŒé©ç”¨ã•ã‚Œã¾ã™ï¼‰ã€‚
3. è¡¨ç¤ºã•ã‚Œã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ `littlefs.bin` ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€‚æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰æ•°ç§’å¾Œã«å†èµ·å‹•ã—ã¾ã™ã€‚

> âš ï¸ **æ³¨æ„**: `/uploadfs` ã¯ãƒã‚¤ãƒŠãƒª1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å—ã‘ä»˜ã‘ã¾ã™ã€‚ãƒ•ã‚©ãƒ«ãƒ€ã‚„è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã‚¢ã‚»ãƒƒãƒˆã‚’æ›´æ–°ã™ã‚‹éš›ã¯å¿…ãš `buildfs` ã§æ–°ã—ã„ LittleFS ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆ`.bin`ï¼‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ãƒ‡ãƒãƒƒã‚°

```bash
# ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰
pio run -e atoms3r --build-type debug

# ä¾‹å¤–ãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ä»˜ããƒ¢ãƒ‹ã‚¿ãƒ¼
pio device monitor -b 115200 --filter esp32_exception_decoder
```

## ğŸ”§ é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### TDDï¼ˆãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼‰

1. æœŸå¾…ã•ã‚Œã‚‹å…¥å‡ºåŠ›ã«åŸºã¥ãã€ã¾ãšãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
2. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€å¤±æ•—ã‚’ç¢ºèª
3. ãƒ†ã‚¹ãƒˆãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèªå¾Œã€ã‚³ãƒŸãƒƒãƒˆ
4. ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã•ã›ã‚‹å®Ÿè£…ã‚’é€²ã‚ã‚‹

### ã‚¯ãƒ©ã‚¹ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

- config, buzzer, LCD, IMUãªã©ã‚’ã‚¯ãƒ©ã‚¹åŒ–
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯ã‚¯ãƒ©ã‚¹å˜ä½ã§æ¤œè¨¼
- ãƒ—ãƒ­ã‚°ãƒ©ãƒ æœ¬ä½“ã¯ã‚¯ãƒ©ã‚¹ã‚’çµ„ã¿åˆã‚ã›ã¦å®Ÿè£…

### ã‚³ãƒŸãƒƒãƒˆè¦ç´„

```bash
# æ©Ÿèƒ½è¿½åŠ 
git commit -m "feat: add imu sensor integration"

# ãƒã‚°ä¿®æ­£
git commit -m "fix: correct led coordinate mapping"

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
git commit -m "docs: update api documentation"
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

- **LEDæ›´æ–°é »åº¦**: 30fpsä»¥ä¸Š
- **èµ·å‹•æ™‚é–“**: 5ç§’ä»¥å†…
- **MQTTå¿œç­”æ™‚é–“**: 100msä»¥å†…
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: PSRam 3MBä»¥å†…

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

1. ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ•ã‚©ãƒ¼ã‚¯
2. æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ (`git checkout -b feature/amazing-feature`)
3. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ (`git commit -m 'feat: add amazing feature'`)
4. ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ (`git push origin feature/amazing-feature`)
5. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ MIT ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ç´°ã¯ [LICENSE](LICENSE) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯

- [æŠ€è¡“ä»•æ§˜æ›¸](isolation_sphere_spec.md)
- [å®Ÿè£…ã‚¿ã‚¹ã‚¯ä¸€è¦§](isolation_sphere_tasks.md)
- [MQTTé€šä¿¡ä»•æ§˜](mqtt_rules.md)
- [é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](AGENTS.md)
- [PlatformIO Documentation](https://docs.platformio.org/)
- [M5Stack Atom S3R](https://docs.m5stack.com/en/core/AtomS3R)

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

è³ªå•ã‚„å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€GitHubã®Issuesãƒšãƒ¼ã‚¸ã§ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚

---

**MFT2025 Isolation Sphere Project** - *Making the impossible visible* ğŸŒŸ
