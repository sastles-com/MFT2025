# MFT2025 MQTT ãƒˆãƒ”ãƒƒã‚¯è¨­è¨ˆè¦ç´„ (å…±é€šè¦ç´„ã¸ã®ãƒªãƒ³ã‚¯)

**âš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯éæ¨å¥¨ã§ã™**

çµ±ä¸€ã•ã‚ŒãŸMQTTè¨­è¨ˆè¦ç´„ã¯ä»¥ä¸‹ã®å…±é€šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

ğŸ“‹ **[../doc/mqtt_rules.md](../doc/mqtt_rules.md)** - MFT2025ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®MQTTçµ±ä¸€è¦ç´„

ğŸ“‹ **[../doc/mqtt_image_transfer_guide.md](../doc/mqtt_image_transfer_guide.md)** - ç”»åƒè»¢é€å°‚ç”¨ã‚¬ã‚¤ãƒ‰

---

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®å®Ÿè£…çŠ¶æ³

### isolation-sphere ã§ã®å®Ÿè£…
- âœ… çµ±ä¸€ãƒˆãƒ”ãƒƒã‚¯è¨­è¨ˆé©ç”¨æ¸ˆã¿
- âœ… å¾Œæ–¹äº’æ›æ€§ç¶­æŒ
- âœ… å€‹åˆ¥åˆ¶å¾¡ + ä¸€æ‹¬åˆ¶å¾¡å¯¾å¿œ
- âœ… ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒãƒ³ãƒ‰åˆ†é›¢

### ä½¿ç”¨ä¸­ã®ãƒˆãƒ”ãƒƒã‚¯ä¾‹
```
{device_type}/{instance_id}/{function}
{device_type}/all/{function}        # ä¸€æ‹¬åˆ¶å¾¡ç”¨
{device_type}/{function}            # å¾Œæ–¹äº’æ›æ€§(éæ¨å¥¨)
```

## Sphereï¼ˆçƒä½“ãƒ‡ãƒã‚¤ã‚¹ï¼‰ãƒˆãƒ”ãƒƒã‚¯

### åˆ¶å¾¡ç³»ãƒˆãƒ”ãƒƒã‚¯

#### UIåˆ¶å¾¡
- `sphere/ui` - å€‹åˆ¥UIåˆ¶å¾¡ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
- `sphere/{instance_id}/ui` - ç‰¹å®šSphere UIåˆ¶å¾¡
- `sphere/all/ui` - å…¨SphereåŒæ™‚UIåˆ¶å¾¡

**ç”¨é€”**: è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã€ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã€è¼åº¦èª¿æ•´ã€UIãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿

**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹**:
```json
{
  "mode": "pattern|demo|debug|off",
  "pattern": "spiral|rainbow|coordinate|wave",
  "brightness": 0-255,
  "ui_mode": "gesture|manual",
  "params": {
    "speed": 1.0,
    "color_offset": 120
  }
}
```

#### ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒãƒ³ãƒ‰
- `sphere/command` - å€‹åˆ¥ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
- `sphere/{instance_id}/command` - ç‰¹å®šSphereã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡
- `sphere/all/command` - å…¨SphereåŒæ™‚ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡

**ç”¨é€”**: é›»æºåˆ¶å¾¡ã€ãƒªã‚»ãƒƒãƒˆã€è¨­å®šä¿å­˜ã€è¨ºæ–­å®Ÿè¡Œã€ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢æ›´æ–°

**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹**:
```json
{
  "action": "restart|shutdown|save_config|calibrate_imu|factory_reset",
  "params": {
    "force": true,
    "backup": false
  }
}
```

### ãƒ‡ãƒ¼ã‚¿ç³»ãƒˆãƒ”ãƒƒã‚¯

#### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Š
- `sphere/status` - å…¨Sphereã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Šå…ˆ
- `sphere/{instance_id}/status` - ç‰¹å®šSphereã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Š

**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹**:
```json
{
  "device_id": "sphere001",
  "timestamp": 1640995200000,
  "uptime_ms": 3600000,
  "status": "ready|busy|error|offline",
  "imu": {
    "quaternion": [0.707, 0.0, 0.0, 0.707],
    "gesture": "shake|tilt|rotation|still"
  },
  "system": {
    "cpu_usage": 45.2,
    "memory_free": 245760,
    "temperature": 42.5
  },
  "led": {
    "current_pattern": "spiral",
    "brightness": 128,
    "fps": 30
  }
}
```

#### ç”»åƒãƒ‡ãƒ¼ã‚¿
- `sphere/image` - ç”»åƒãƒ‡ãƒ¼ã‚¿é…ä¿¡ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
- `sphere/{instance_id}/image` - ç‰¹å®šSphereç”»åƒãƒ‡ãƒ¼ã‚¿
- `sphere/all/image` - å…¨SphereåŒæ™‚ç”»åƒé…ä¿¡

**ç”¨é€”**: JPEGç”»åƒã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã€ãƒ†ã‚¯ã‚¹ãƒãƒ£é…ä¿¡

## Joystickï¼ˆã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‰ãƒˆãƒ”ãƒƒã‚¯

### åˆ¶å¾¡ç³»ãƒˆãƒ”ãƒƒã‚¯

#### UIåˆ¶å¾¡
- `joystick/{instance_id}/ui` - ç‰¹å®šJoystick UIåˆ¶å¾¡
- `joystick/all/ui` - å…¨JoystickåŒæ™‚UIåˆ¶å¾¡

**ç”¨é€”**: è¡¨ç¤ºå†…å®¹å¤‰æ›´ã€ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã€è¨­å®šèª¿æ•´

**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹**:
```json
{
  "display_mode": "sphere_control|video_management|settings",
  "brightness": 0-255,
  "ui_layout": "dual_dial|single_stick|custom"
}
```

#### ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒãƒ³ãƒ‰
- `joystick/{instance_id}/command` - ç‰¹å®šJoystickã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡
- `joystick/all/command` - å…¨JoystickåŒæ™‚ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡

### ãƒ‡ãƒ¼ã‚¿ç³»ãƒˆãƒ”ãƒƒã‚¯

#### å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
- `joystick/{instance_id}/input` - ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯å…¥åŠ›ãƒ‡ãƒ¼ã‚¿

**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹**:
```json
{
  "timestamp": 1640995200123,
  "left_stick": {"x": 0.25, "y": -0.80},
  "right_stick": {"x": -0.50, "y": 0.10},
  "buttons": {
    "a": true, "b": false, "start": false, "select": false
  },
  "sequence": 12345
}
```

#### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Š
- `joystick/{instance_id}/status` - Joystickã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Š

## RasPiï¼ˆåˆ¶å¾¡ãƒãƒ–ï¼‰ãƒˆãƒ”ãƒƒã‚¯

### ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†
- `raspi/system/command` - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®åˆ¶å¾¡
- `raspi/system/status` - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

### ãƒ¡ãƒ‡ã‚£ã‚¢ç®¡ç†
- `raspi/media/command` - ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
- `raspi/media/status` - ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçŠ¶æ³
- `raspi/media/playlist` - ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé…ä¿¡

## ã‚¯ãƒ­ã‚¹ãƒ‡ãƒã‚¤ã‚¹é€šä¿¡

### ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒˆãƒ”ãƒƒã‚¯
- `system/all/sync` - å…¨ãƒ‡ãƒã‚¤ã‚¹åŒæœŸã‚³ãƒãƒ³ãƒ‰
- `system/all/emergency` - ç·Šæ€¥åœæ­¢ãƒ»ãƒªã‚»ãƒƒãƒˆ

**åŒæœŸã‚³ãƒãƒ³ãƒ‰ä¾‹**:
```json
{
  "action": "sync_start|sync_stop|time_sync",
  "timestamp": 1640995200000,
  "params": {
    "pattern": "rainbow",
    "duration_ms": 30000,
    "sync_fps": 30
  }
}
```

## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDå‘½åè¦å‰‡

### Sphere
- `001`, `002`, `003` ... - 3æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°æ•°å­—
- å°†æ¥çš„ã« `main`, `sub1`, `sub2` ãªã©ã®åå‰ä»˜ãIDã‚‚å¯¾å¿œ

### Joystick  
- `j001`, `j002` - ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯å°‚ç”¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
- ã¾ãŸã¯ `001`, `002` ã§Sphereã¨å…±é€šç•ªå·ä½“ç³»

### RasPi
- `hub` - åˆ¶å¾¡ãƒãƒ–å›ºå®šå
- `main` - ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼

## QoSè¨­å®šæ–¹é‡

| ãƒˆãƒ”ãƒƒã‚¯ã‚¿ã‚¤ãƒ— | QoS | Retain | èª¬æ˜ |
|--------------|-----|--------|------|
| UIåˆ¶å¾¡ | 1 | false | ç¢ºå®Ÿãªé…ä¿¡ã€é‡è¤‡è¨±å¯ |
| ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒãƒ³ãƒ‰ | 2 | false | é‡è¦ã‚³ãƒãƒ³ãƒ‰ã€é‡è¤‡ç¦æ­¢ |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | 0 | true | é«˜é »åº¦ã€æœ€æ–°çŠ¶æ…‹ä¿æŒ |
| å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ | 0 | false | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã€é…å»¶å³ç¦ |
| ç”»åƒãƒ‡ãƒ¼ã‚¿ | 1 | false | å¤§å®¹é‡ã€ç¢ºå®Ÿé…ä¿¡ |
| ç·Šæ€¥ã‚³ãƒãƒ³ãƒ‰ | 2 | false | æœ€é‡è¦ã€ç¢ºå®Ÿé…ä¿¡ |

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®

### èªè¨¼
- MQTTèªè¨¼: åŸºæœ¬èªè¨¼ï¼ˆé–‹ç™ºæ™‚ã¯ç„¡åŠ¹ï¼‰
- SSL/TLS: æœ¬ç•ªæ™‚ã¯å¿…é ˆ

### ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- Readæ¨©é™: å…¨ãƒ‡ãƒã‚¤ã‚¹ â†’ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç³»ãƒˆãƒ”ãƒƒã‚¯
- Writeæ¨©é™: ç®¡ç†è€…ã®ã¿ â†’ ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒãƒ³ãƒ‰
- Writeæ¨©é™: ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ UIåˆ¶å¾¡

## å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### é€ä¿¡å´
1. å€‹åˆ¥åˆ¶å¾¡æ™‚ã¯ `{device_type}/{instance_id}/{function}` ã‚’ä½¿ç”¨
2. ä¸€æ‹¬åˆ¶å¾¡æ™‚ã¯ `{device_type}/all/{function}` ã‚’ä½¿ç”¨
3. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å¿…ãšå«ã‚ã‚‹
4. ã‚¨ãƒ©ãƒ¼å‡¦ç†ã§é‡è¤‡é€ä¿¡ã‚’é¿ã‘ã‚‹

### å—ä¿¡å´
1. è‡ªåˆ†å°‚ç”¨ãƒˆãƒ”ãƒƒã‚¯ + `/all/` ãƒˆãƒ”ãƒƒã‚¯ã‚’è³¼èª­
2. é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ sequence ã¾ãŸã¯ timestamp ã§æ¤œå‡º
3. ä¸æ­£ãªJSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ç„¡è¦–
4. å‡¦ç†çµæœã‚’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§å ±å‘Š

### é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°
- `debug/{device_type}/{instance_id}` - é–‹ç™ºæ™‚ãƒ­ã‚°å‡ºåŠ›
- `test/{any_topic}` - ãƒ†ã‚¹ãƒˆå°‚ç”¨ãƒˆãƒ”ãƒƒã‚¯ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹ï¼‰

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ

å„ãƒ‡ãƒã‚¤ã‚¹ã® `config.json` ã«ä»¥ä¸‹ã®å½¢å¼ã§ãƒˆãƒ”ãƒƒã‚¯è¨­å®šã‚’è¨˜è¼‰ï¼š

```json
{
  "mqtt": {
    "topics": {
      "ui": "sphere/ui",
      "ui_all": "sphere/all/ui", 
      "ui_individual": "sphere/{instance_id}/ui",
      "command": "sphere/command",
      "command_all": "sphere/all/command",
      "command_individual": "sphere/{instance_id}/command",
      "status": "sphere/{instance_id}/status",
      "image": "sphere/{instance_id}/image"
    }
  }
}
```

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

- æœ¬è¦ç´„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v1.0
- äº’æ›æ€§: å¾Œæ–¹äº’æ›æ€§ã‚’é‡è¦–ã€deprecationè­¦å‘Šå¾Œå‰Šé™¤
- å¤‰æ›´ãƒ­ã‚°: å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®å¤‰æ›´ç‚¹ã‚’è¨˜éŒ²