# UI 操作ルール（Isolation Sphere）

## 1. UIモードへの遷移

- デフォルト状態では UI モードは無効です。
- デバイスを **shake（3連続の強い加速度イベント）** させると UI モードに入ります。
- UI モード中は LCD に「XYZ 軸インジケータ」が表示され、各方向の操作でコマンドを発行できます。
- 再度 shake すると UI モードを終了し、通常表示へ戻ります。UI モード終了時はコマンドを送信しません。

## 2. 軸インジケータと基本コマンド

UI モードでは、球体を軸方向に回転させることで以下 6 種類のコマンド（正方向／逆方向）を発行します。

| 軸 | 方向 | コマンドID | 想定アクション例 |
|----|------|------------|------------------|
| X  | 正   | `ui:x_pos` | 次のメニューへ進む、あるいは「右」方向の操作 |
| X  | 負   | `ui:x_neg` | 前のメニューへ戻る、あるいは「左」方向の操作 |
| Y  | 正   | `ui:y_pos` | 決定／選択、あるいは「上」方向の操作 |
| Y  | 負   | `ui:y_neg` | キャンセル／戻る、あるいは「下」方向の操作 |
| Z  | 正   | `ui:z_pos` | 再生／スタートなど Z 軸の正方向アクション |
| Z  | 負   | `ui:z_neg` | 停止／ポーズなど Z 軸の負方向アクション |

> コマンド ID は MQTT `sphere/ui` トピックのペイロードに含める JSON の `command` フィールド値として利用します。

### 設計上の前提

- **握ったまま操作する球体デバイス** であるため、左右・上下だけでなく、軸の正逆を区別できる操作体系が必要です。
- **音（ブザー）** は鳴らせるが複雑なUIを表示する余地は少ないため、コマンド到達やエラーなどは短い効果音でフィードバックする想定です。
- **LCD は小型で最低限の情報のみ** 表示できるため、軸インジケータは簡素なグラフィック（XYZ方向のガイド）に留め、詳細なメニュー構造は外部デバイスや音声フィードバックで補います。
- 操作の確実性を高めるため、一度コマンドを発行した方向とは**一定角度戻ってから**再度発行するなどのヒステリシスを設けると良いでしょう（実装時に検討）。

## 3. LEDリアクションと感度表現

UI 操作中は LED 球面でフィードバックを行い、感度や選択状況を視覚化します。

### 3.1 コマンド別カラーリング

| コマンドID | LED カラー例 |
|-------------|---------------|
| `ui:x_pos`  | シアン（#00FFFF）|
| `ui:x_neg`  | オレンジ（#FFA500）|
| `ui:y_pos`  | グリーン（#00FF7F）|
| `ui:y_neg`  | バイオレット（#9933FF）|
| `ui:z_pos`  | イエロー（#FFFF66）|
| `ui:z_neg`  | レッド（#FF3366）|

### 3.2 カラーアニメーション

- X 軸：中央から左右へカラーが流れるアニメーション。
- Y 軸：**上から下へ**カラーが降りてくる（正方向）／**下から上へ**カラーが昇ってくる（負方向）。
- Z 軸：球体全体にリング状のカラーが拡散／収束するアニメーション。

### 3.3 感度と選択演出

- 操作しそうな軸が検出されたら、XYZ インジケータと LED の点滅で “構え” を通知。軸に沿ったハイライトを増やして方向を明示します。
- 回転角が閾値に近づくにつれ、LED の輝度や点滅速度を徐々に上げて「もうすぐ選択される」ことを示します。
- 閾値を超えてコマンドが確定したら、該当カラーで 1 秒程度明滅させ、音（効果音）と合わせてフィードバックします。
- コマンド確定後はヒステリシスが解除されるまで彩度を抑えて「クールダウン中」であることを示します。

## 4. UIモード時のマルチモーダルフィードバック

- UIモード突入時に短い連続音（例: 「プ・プ」）を再生し、モード切替を耳でも確認できるようにします。
- UIモード ON/OFF は `sphere/status` の JSON に `"ui_mode": true|false` を追加して publish し、外部コントローラが同期できるようにします。
- UIモード中の画面暗転レベルは、`config.json` の設定および `sphere/ui` コマンドで切り替え可能とし、デフォルトは「半透明ダークレイヤ」に設定します。
- 初期挙動として、UIモードに入った瞬間に LCD の輝度を 50% へ下げ、UIモード終了時に元の輝度へ戻します（この機能も `config.json` フラグで有効/無効を切替可能にする）。


### JSON ペイロード例

```json
{
  "command": "ui:x_pos",
  "timestamp": 1737436800000,
  "source": "gesture"
}
```

- `command` … 上記 6 種類のいずれか。
- `timestamp` … 任意。Unix epoch ミリ秒などを推奨。
- `source` … コマンドの発生元を識別する用途（例: `gesture`, `mqtt`）。

## 3. MQTT 連携

- `sphere/ui` トピックを購読し、受信したペイロードを **SharedState** に格納して全タスクで共有します。
- UI モード時に軸操作で検出したコマンドは同トピックへ publish し、外部システムと同期させられるようにします（双方向同期）。
- コマンド受信時は UI モードの表示状態に関係なく、共通のハンドラで処理します。
- ステータスは `sphere/status` で定期送信されるため、UI モードの ON/OFF や最新コマンド情報も必要に応じて JSON へ拡張します。

## 4. 拡張コマンドについて

- 将来的に複雑な操作（長押し、連続回転、組み合わせジェスチャなど）を導入する場合は、新しいコマンド ID を `ui:` プレフィックス付きで追加します。
- 追加コマンドは MQTT／SharedState 双方で認識させるため、このドキュメントに追記し、コマンド表を更新してください。
- UI モードに入るトリガー（shake）や UI 表示内容を変更する場合も、本ルールに準じて更新内容を反映します。

## 5. 実装メモ

- `SharedState::updateUiCommand()` / `getUiCommand()` を利用してコマンドをキューイングします。必要に応じて FIFO バッファへ拡張可能です。
- MQTT publish/subscribe は `MqttService` が担当。UI コマンド発生時は `publishStatus()` の payload へ最新コマンドを含めるなどの整合性に留意します。
- LCD インジケータは UI モード ON の間だけ描画し、UI モードが OFF になった瞬間に消去します。

以上が現時点の UI 操作ルールです。変更や拡張が生じた際は `ui_rules.md` を更新し、UI と MQTT の仕様を常に同期させてください。
